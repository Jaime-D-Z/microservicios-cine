version: '3.8'

services:
  # ========================================
  # üóÑÔ∏è BASES DE DATOS
  # ========================================
  
  postgres:
    image: postgres:15
    container_name: cine-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres123
      POSTGRES_DB: cine_db
    ports:
      - "5433:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - cine-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  mongodb:
    image: mongo:7
    container_name: cine-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: admin123
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    networks:
      - cine-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: cine-redis
    ports:
      - "6379:6379"
    networks:
      - cine-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  rabbitmq:
    image: rabbitmq:3-management
    container_name: cine-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin123
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - cine-network
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 30s
      timeout: 10s
      retries: 5

  # ========================================
  # üåê API GATEWAY
  # ========================================
  
  api-gateway:
    build: ./api-gateway
    container_name: cine-gateway
    ports:
      - "8080:8080"
    environment:
      PORT: 8080
      JWT_SECRET: "SUPER_SECRET_KEY_2026"
      USERS_SERVICE: http://ms-users:3000
      MOVIES_SERVICE: http://ms-movies:8000
      TICKETS_SERVICE: http://ms-tickets:5000
      SHOWTIMES_SERVICE: http://ms-showtimes:4000
      PAYMENTS_SERVICE: http://ms-payments:6000
      NOTIFICATIONS_SERVICE: http://ms-notifications:7000
      REVIEWS_SERVICE: http://ms-reviews:9000
      LOYALTY_SERVICE: http://ms-loyalty:10000
      ANALYTICS_SERVICE: http://ms-analytics:11000
    depends_on:
      - ms-users
      - ms-movies
      - ms-tickets
      - ms-showtimes
      - ms-payments
      - ms-notifications
      - ms-reviews
      - ms-loyalty
      - ms-analytics
    networks:
      - cine-network

  # ========================================
  # üé¨ MICROSERVICIOS
  # ========================================
  
  ms-users:
    build: ./ms-users
    container_name: cine-ms-users
    ports:
      - "3000:3000"
    environment:
      PORT: 3000
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: postgres123
      DB_NAME: cine_db
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - cine-network

  ms-movies:
    build: ./ms-movies
    container_name: cine-ms-movies
    ports:
      - "8000:8000"
    environment:
      PORT: 8000
      MONGO_URI: mongodb://admin:admin123@mongodb:27017
      MONGO_DB: cine_db
      REDIS_HOST: redis
      REDIS_PORT: 6379
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - cine-network

  ms-tickets:
    build: ./ms-tickets
    container_name: cine-ms-tickets
    ports:
      - "5000:5000"
    environment:
      PORT: 5000
      USERS_SERVICE: http://ms-users:3000
      SHOWTIMES_SERVICE: http://ms-showtimes:4000
      NOTIFICATIONS_SERVICE: http://ms-notifications:7000
    networks:
      - cine-network

  ms-showtimes:
    build: ./ms-showtimes
    container_name: cine-ms-showtimes
    ports:
      - "4000:4000"
    environment:
      PORT: 4000
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: postgres123
      DB_NAME: cine_db
      TICKETS_SERVICE: http://ms-tickets:5000
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - cine-network

  ms-payments:
    build: ./ms-payments
    container_name: cine-ms-payments
    ports:
      - "6000:6000"
    environment:
      PORT: 6000
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: postgres123
      DB_NAME: cine_db
      NOTIFICATIONS_SERVICE: http://ms-notifications:7000
      STRIPE_SECRET_KEY: "sk_test_..."
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - cine-network

  ms-notifications:
    build: ./ms-notifications
    container_name: cine-ms-notifications
    ports:
      - "7000:7000"
    environment:
      PORT: 7000
      USERS_SERVICE: http://ms-users:3000
      SMTP_HOST: smtp.gmail.com
      SMTP_PORT: 587
      SMTP_USER: your-email@gmail.com
      SMTP_PASS: your-app-password
      EMAIL_FROM: "Cin√©Plex <noreply@cineplex.com>"
    networks:
      - cine-network

  ms-reviews:
    build: ./ms-reviews
    container_name: cine-ms-reviews
    ports:
      - "9000:9000"
    environment:
      PORT: 9000
      MONGO_URI: mongodb://admin:admin123@mongodb:27017
      MONGO_DB: cine_db
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - cine-network

  ms-loyalty:
    build: ./ms-loyalty
    container_name: cine-ms-loyalty
    ports:
      - "10000:10000"
    environment:
      PORT: 10000
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: postgres123
      DB_NAME: cine_db
      USERS_SERVICE: http://ms-users:3000
      NOTIFICATIONS_SERVICE: http://ms-notifications:7000
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - cine-network

  ms-analytics:
    build: ./ms-analytics
    container_name: cine-ms-analytics
    ports:
      - "11000:11000"
    environment:
      PORT: 11000
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: postgres123
      DB_NAME: cine_db
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - cine-network

  # ========================================
  # üîß NGINX LOAD BALANCER (Opcional)
  # ========================================
  
  nginx:
    image: nginx:alpine
    container_name: cine-nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - api-gateway
    networks:
      - cine-network

# ========================================
# üì¶ VOLUMES
# ========================================

volumes:
  postgres_data:
  mongodb_data:

# ========================================
# üåê NETWORKS
# ========================================

networks:
  cine-network:
    driver: bridge
